<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MateChat - Railway + Etiquetas + API config</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-left">
        <div class="app-logo">MateChat</div>
        <div class="app-status" id="status">Esperando conexión...</div>
      </div>
      <div class="header-right">
        <button class="config-btn" onclick="toggleConfigPanel()">Config webhook</button>
        <button class="config-btn" onclick="toggleAPIConfigPanel()">Config API</button>
        <button class="label-btn" onclick="toggleLabelManager()">Etiquetas</button>
        <!-- Nuevo botón para el gestor de webhooks -->
        <button class="config-btn" onclick="toggleWebhookManager()">Gestor Webhooks</button>
      </div>
    </header>

    <!-- Overlay de QR -->
    <div class="qr-overlay" id="qr-code"></div>

    <div class="main-content" id="main-content">
      <!-- Barra lateral de chats -->
      <aside class="sidebar">
        <div class="sidebar-header">Chats</div>
        <ul class="chat-list" id="chat-list"></ul>
      </aside>
      <!-- Área de mensajes -->
      <section class="chat-area">
        <div class="chat-header" id="chat-header">
          <h3>Selecciona un chat</h3>
        </div>
        <div class="chat-messages" id="message-list"></div>
        <div class="chat-input-container" id="message-section">
          <input type="text" id="message-input" placeholder="Escribe un mensaje...">
          <button class="send-btn" onclick="sendMessage()">Enviar</button>
        </div>
      </section>
    </div>

    <!-- Panel Webhook (configuración actual, para un único webhook si se desea) -->
    <div class="config-panel" id="config-panel" style="display: none;">
      <h2>Config Webhook</h2>
      <label>URL:</label>
      <input type="text" id="webhook-url">
      <div class="checkbox-row">
        <input type="checkbox" id="cb-onreceive">
        <label>onMessageReceived</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="cb-onsent">
        <label>onMessageSent</label>
      </div>
      <button class="save-config-btn" onclick="saveWebhookConfig()">Guardar</button>
    </div>

    <!-- Panel Config API -->
    <div class="config-panel" id="api-config-panel" style="display: none; top: 200px;">
      <h2>Config API</h2>
      <div class="checkbox-row">
        <input type="checkbox" id="cb-api-enabled">
        <label>Habilitar API</label>
      </div>
      <label>API Key:</label>
      <input type="text" id="api-key-input" placeholder="Ej: 123456" />
      <button class="save-config-btn" onclick="saveAPIConfig()">Guardar</button>
    </div>

    <!-- Panel Etiquetas -->
    <div class="label-manager-panel" id="label-manager-panel" style="display:none;">
      <h2>Etiquetas Globales</h2>
      <div id="label-list"></div>
      <h3>Nueva etiqueta</h3>
      <input type="text" id="new-label-name" placeholder="Nombre...">
      <input type="color" id="new-label-color" value="#dd3333">
      <button class="add-label-btn" onclick="createLabel()">Crear</button>
    </div>

    <!-- Panel Gestor de Webhooks -->
    <div class="webhook-manager-panel" id="webhook-manager-panel" style="display: none;">
      <h2>Gestor de Webhooks</h2>
      <div id="webhook-list">
        <!-- Se listarán los webhooks configurados -->
      </div>
      <h3>Agregar nuevo Webhook</h3>
      <label>URL:</label>
      <input type="text" id="new-webhook-url" placeholder="https://tu-webhook.com">
      <div class="checkbox-row">
        <input type="checkbox" id="new-cb-onreceive">
        <label>onMessageReceived</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="new-cb-onsent">
        <label>onMessageSent</label>
      </div>
      <button class="save-config-btn" onclick="addWebhook()">Agregar Webhook</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const statusText = document.getElementById('status');
    const qrOverlay = document.getElementById('qr-code');
    const mainContent = document.getElementById('main-content');
    const chatList = document.getElementById('chat-list');
    const chatHeader = document.getElementById('chat-header');
    const messageList = document.getElementById('message-list');
    const messageInput = document.getElementById('message-input');
    const messageSection = document.getElementById('message-section');

    // Panel Webhook (configuración única, si se desea usarlo)
    const configPanel = document.getElementById('config-panel');
    const webhookUrl = document.getElementById('webhook-url');
    const cbOnReceive = document.getElementById('cb-onreceive');
    const cbOnSent = document.getElementById('cb-onsent');

    // Panel API
    const apiConfigPanel = document.getElementById('api-config-panel');
    const cbAPIEnabled = document.getElementById('cb-api-enabled');
    const apiKeyInput = document.getElementById('api-key-input');

    // Panel Etiquetas
    const labelManagerPanel = document.getElementById('label-manager-panel');
    const labelListDiv = document.getElementById('label-list');
    const newLabelName = document.getElementById('new-label-name');
    const newLabelColor = document.getElementById('new-label-color');

    // Panel Gestor de Webhooks
    const webhookManagerPanel = document.getElementById('webhook-manager-panel');
    const webhookListDiv = document.getElementById('webhook-list');
    const newWebhookUrl = document.getElementById('new-webhook-url');
    const newCbOnReceive = document.getElementById('new-cb-onreceive');
    const newCbOnSent = document.getElementById('new-cb-onsent');

    let selectedChat = null;
    let allLabels = [];
    let chatLabels = {};

    // 1) EVENTOS SERVIDOR
    socket.on('qr', (qrUrl) => {
      qrOverlay.innerHTML = `<img src="${qrUrl}" alt="QR">`;
      qrOverlay.style.display = 'flex';
      statusText.textContent = 'Escanea el QR';
    });
    socket.on('qr-error', (err) => {
      qrOverlay.innerHTML = `<p style="color:red;">${err}</p>`;
    });
    socket.on('connected', (isConnected) => {
      if (isConnected) {
        qrOverlay.style.display = 'none';
        mainContent.style.display = 'flex';
        statusText.textContent = 'Conectado a WhatsApp';
        socket.emit('get-all-labels');
      } else {
        mainContent.style.display = 'none';
        statusText.textContent = 'Desconectado';
      }
    });
    socket.on('chats', (chats) => {
      renderChatList(chats);
    });
    socket.on('chat-history', (data) => {
      if (!selectedChat || selectedChat.id !== data.chatId) return;
      messageList.innerHTML = '';
      data.messages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('message', msg.fromMe ? 'sent' : 'received');
        div.textContent = msg.body;
        messageList.appendChild(div);
      });
      messageList.scrollTop = messageList.scrollHeight;
    });
    socket.on('chat-history-error', console.error);
    socket.on('new-message', (message) => {
      if (selectedChat && message.id === selectedChat.id) {
        const div = document.createElement('div');
        div.classList.add('message', message.fromMe ? 'sent' : 'received');
        div.textContent = message.text;
        messageList.appendChild(div);
        messageList.scrollTop = messageList.scrollHeight;
      }
    });
    socket.on('message-sent', (data) => {
      if (selectedChat && data.to === selectedChat.id) {
        const div = document.createElement('div');
        div.classList.add('message', 'sent');
        div.textContent = data.text;
        messageList.appendChild(div);
        messageList.scrollTop = messageList.scrollHeight;
      }
    });

    // Webhook config (único)
    socket.on('webhook-config-updated', (cfg) => {
      webhookUrl.value = cfg.url;
      cbOnReceive.checked = cfg.onMessageReceived;
      cbOnSent.checked = cfg.onMessageSent;
    });
    // API Config
    socket.on('api-config-updated', (cfg) => {
      cbAPIEnabled.checked = cfg.enabled;
      apiKeyInput.value = cfg.apiKey;
    });

    // Etiquetas
    socket.on('all-labels', (labels) => {
      allLabels = labels;
      renderGlobalLabels();
      socket.emit('chats'); 
    });
    socket.on('chat-labels-updated', (cl) => {
      chatLabels = cl;
      socket.emit('chats');
    });

    // 2) FUNCIONES
    function renderChatList(chats) {
      chatList.innerHTML = '';
      chats.forEach(chat => {
        const li = document.createElement('li');
        li.classList.add('chat-item');
        li.textContent = chat.name;

        // Etiquetas (badges)
        const badgeContainer = document.createElement('div');
        badgeContainer.style.marginTop = '5px';
        if (chatLabels[chat.id]) {
          chatLabels[chat.id].forEach(labelId => {
            const lbl = allLabels.find(l => l.id === labelId);
            if (lbl) {
              const badge = document.createElement('span');
              badge.classList.add('label-badge');
              badge.style.backgroundColor = lbl.color;
              badge.textContent = lbl.name;
              badgeContainer.appendChild(badge);
            }
          });
        }
        li.appendChild(badgeContainer);

        // clic izq => abrir chat
        li.onclick = () => selectChat({ id: chat.id, name: chat.name });

        // clic derecho => menú contextual para etiquetas
        li.oncontextmenu = (e) => {
          e.preventDefault();
          // Función para menú contextual si se desea implementar
        };

        chatList.appendChild(li);
      });
    }

    function selectChat(chat) {
      selectedChat = chat;
      chatHeader.innerHTML = `<h3>${chat.name}</h3>`;
      messageSection.style.display = 'flex';
      messageList.innerHTML = '';
      socket.emit('select-chat', chat.id);
      messageInput.focus();
    }

    function sendMessage() {
      if (selectedChat && messageInput.value.trim()) {
        const text = messageInput.value;
        socket.emit('send-message', { to: selectedChat.id, text });
        messageInput.value = '';
      }
    }
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Menú contextual (etiquetas)
    function renderGlobalLabels() {
      labelListDiv.innerHTML = '';
      allLabels.forEach(lbl => {
        const row = document.createElement('div');
        row.classList.add('label-row');
        const colorBox = document.createElement('span');
        colorBox.classList.add('label-color-box');
        colorBox.style.backgroundColor = lbl.color;
        const lblName = document.createElement('span');
        lblName.textContent = lbl.name;
        lblName.style.marginLeft = '6px';
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Eliminar';
        delBtn.classList.add('delete-label-btn');
        delBtn.onclick = () => {
          if (confirm('¿Eliminar etiqueta?')) {
            socket.emit('delete-label', lbl.id);
          }
        };
        row.appendChild(colorBox);
        row.appendChild(lblName);
        row.appendChild(delBtn);
        labelListDiv.appendChild(row);
      });
    }
    function createLabel() {
      const data = {
        name: newLabelName.value.trim(),
        color: newLabelColor.value
      };
      if (!data.name) {
        alert('Falta nombre de etiqueta');
        return;
      }
      socket.emit('create-label', data);
      newLabelName.value = '';
      newLabelColor.value = '#dd3333';
    }

    // Panel Webhook (único)
    function toggleConfigPanel() {
      configPanel.style.display = (configPanel.style.display === 'none') ? 'block' : 'none';
    }
    function saveWebhookConfig() {
      const cfg = {
        url: webhookUrl.value.trim(),
        onMessageReceived: cbOnReceive.checked,
        onMessageSent: cbOnSent.checked
      };
      socket.emit('update-webhook-config', cfg);
      configPanel.style.display = 'none';
    }

    // Panel API
    function toggleAPIConfigPanel() {
      apiConfigPanel.style.display = (apiConfigPanel.style.display === 'none') ? 'block' : 'none';
    }
    function saveAPIConfig() {
      const cfg = {
        enabled: cbAPIEnabled.checked,
        apiKey: apiKeyInput.value.trim()
      };
      socket.emit('update-api-config', cfg);
      apiConfigPanel.style.display = 'none';
    }

    // Panel Etiquetas
    function toggleLabelManager() {
      labelManagerPanel.style.display = (labelManagerPanel.style.display === 'none') ? 'block' : 'none';
      if (labelManagerPanel.style.display === 'block') {
        socket.emit('get-all-labels');
      }
    }

    // Panel Gestor de Webhooks
    function toggleWebhookManager() {
      webhookManagerPanel.style.display = (webhookManagerPanel.style.display === 'none') ? 'block' : 'none';
      if (webhookManagerPanel.style.display === 'block') {
        fetchWebhooks();
      }
    }
    // Función para obtener la lista de webhooks del servidor
    function fetchWebhooks() {
      fetch('/api/webhooks')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderWebhookList(data.webhooks);
          } else {
            alert('Error al obtener webhooks');
          }
        })
        .catch(error => {
          console.error('Error fetching webhooks', error);
        });
    }
    // Renderizar la lista de webhooks en el panel
    function renderWebhookList(webhooks) {
      webhookListDiv.innerHTML = '';
      if (webhooks.length === 0) {
        webhookListDiv.innerHTML = '<p>No hay webhooks configurados.</p>';
        return;
      }
      webhooks.forEach(hook => {
        const div = document.createElement('div');
        div.classList.add('webhook-item');
        div.innerHTML = `<span>${hook.url}</span>
          <span>${hook.onMessageReceived ? 'Recibe' : ''}</span>
          <span>${hook.onMessageSent ? 'Envía' : ''}</span>
          <button onclick="deleteWebhook('${hook.url}')">Eliminar</button>`;
        webhookListDiv.appendChild(div);
      });
    }
    // Agregar nuevo webhook
    function addWebhook() {
      const url = newWebhookUrl.value.trim();
      const onMessageReceived = newCbOnReceive.checked;
      const onMessageSent = newCbOnSent.checked;
      if (!url) {
        alert('La URL es obligatoria');
        return;
      }
      const newWebhook = { url, onMessageReceived, onMessageSent };
      fetch('/api/webhooks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(newWebhook)
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Webhook agregado');
            fetchWebhooks();
            newWebhookUrl.value = '';
            newCbOnReceive.checked = false;
            newCbOnSent.checked = false;
          } else {
            alert('Error al agregar webhook: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error adding webhook:', error);
          alert('Error al agregar webhook');
        });
    }
    // Eliminar webhook
    function deleteWebhook(url) {
      if (!confirm('¿Eliminar este webhook?')) return;
      fetch('/api/webhooks', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Webhook eliminado');
            fetchWebhooks();
          } else {
            alert('Error al eliminar webhook: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error deleting webhook:', error);
          alert('Error al eliminar webhook');
        });
    }
  </script>
</body>
</html>

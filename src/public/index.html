<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MateChat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: white;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        .logo-text {
            font-size: 18px;
            color: #128C7E;
            font-weight: bold;
        }
        
        .disconnect-btn {
            background-color: #E74C3C;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-card {
            background-color: white;
            width: 100%;
            max-width: 780px;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .card-title {
            font-size: 24px;
            color: #444;
            margin-bottom: 15px;
        }
        
        .card-subtitle {
            color: #666;
            margin-bottom: 25px;
        }
        
        .steps {
            text-align: left;
            margin-left: 20px;
            margin-bottom: 25px;
        }
        
        .steps li {
            margin-bottom: 10px;
            color: #555;
        }
        
        .qr-container {
            margin: 30px auto;
            width: 200px;
            height: 200px;
            border: 1px solid #ddd;
            padding: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .qr-code {
            max-width: 100%;
            max-height: 100%;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .checkbox-container input {
            margin-right: 10px;
        }
        
        .alt-login {
            color: #128C7E;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #888;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .footer img {
            width: 16px;
            height: 16px;
            margin: 0 5px;
        }

        .connection-info {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #D5F5E3;
            border-radius: 8px;
        }

        .loading-indicator {
            display: none;
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }

        .error-message {
            display: none;
            color: #E74C3C;
            margin-top: 10px;
        }

        .success-info {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div style="width: 30px; height: 30px; background-color: #128C7E; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
                <div style="width: 15px; height: 15px; background-color: white; border-radius: 50%;"></div>
            </div>
            <span class="logo-text">MateChat</span>
        </div>
        <button id="disconnectBtn" class="disconnect-btn">Desconectar</button>
    </div>
    
    <div class="main-content">
        <div class="login-card">
            <h2 class="card-title">Inicia sesi√≥n en MateChat</h2>
            <p class="card-subtitle">Env√≠a mensajes privados a tus amigos y familiares a trav√©s de WhatsApp en tu navegador.</p>
            
            <ol class="steps">
                <li>Abre WhatsApp en tu tel√©fono.</li>
                <li>Toca Men√∫ ‚ãÆ en Android o Ajustes ‚öôÔ∏è ‚öôÔ∏è en iPhone.</li>
                <li>Toca Dispositivos vinculados y, luego, Vincular un dispositivo.</li>
                <li>Apunta tu tel√©fono hacia esta pantalla para escanear el c√≥digo QR.</li>
            </ol>
            
            <div class="qr-container" id="qrContainer">
                <div class="loading-indicator" id="loadingIndicator">Generando c√≥digo QR...</div>
                <img src="" alt="C√≥digo QR" class="qr-code" id="qrCode" style="display: none;">
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="connection-info" id="connectionInfo">
                <h3>¬°Conexi√≥n exitosa!</h3>
                <p>WhatsApp conectado para: <span id="userName">Usuario</span></p>
                <p>N√∫mero: <span id="userNumber">+123456789</span></p>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="keepSession" checked>
                <label for="keepSession">Mantener la sesi√≥n iniciada en este navegador</label>
                <span style="margin-left: 5px;">‚ìò</span>
            </div>
            
            <a href="#" class="alt-login" id="altLoginBtn">Iniciar sesi√≥n con n√∫mero de tel√©fono</a>
        </div>
    </div>
    
    <div class="footer">
        <span>üîí üîí</span>
        <span>Tus mensajes personales est√°n cifrados de extremo a extremo</span>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const qrCode = document.getElementById('qrCode');
            const qrContainer = document.getElementById('qrContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const connectionInfo = document.getElementById('connectionInfo');
            const userName = document.getElementById('userName');
            const userNumber = document.getElementById('userNumber');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const altLoginBtn = document.getElementById('altLoginBtn');

            // Mostrar cargando
            loadingIndicator.style.display = 'block';
            
            // Iniciar conexi√≥n
            socket.emit('startConnection');

            // Recibir c√≥digo QR
            socket.on('qrCode', (qrUrl) => {
                loadingIndicator.style.display = 'none';
                qrCode.style.display = 'block';
                qrCode.src = qrUrl;
                errorMessage.style.display = 'none';
            });

            // Manejar error de autenticaci√≥n
            socket.on('authFailure', (message) => {
                loadingIndicator.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = `Error de autenticaci√≥n: ${message}`;
            });

            // Manejar desconexi√≥n de WhatsApp
            socket.on('whatsappDisconnected', (reason) => {
                loadingIndicator.style.display = 'none';
                qrCode.style.display = 'none';
                connectionInfo.style.display = 'none';
                disconnectBtn.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = `WhatsApp desconectado: ${reason}`;
                
                // Reintentar conexi√≥n despu√©s de 3 segundos
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                    loadingIndicator.style.display = 'block';
                    socket.emit('startConnection');
                }, 3000);
            });

            // Manejar conexi√≥n exitosa
            socket.on('whatsappReady', (info) => {
                loadingIndicator.style.display = 'none';
                qrCode.style.display = 'none';
                connectionInfo.style.display = 'block';
                disconnectBtn.style.display = 'block';
                errorMessage.style.display = 'none';
                
                userName.textContent = info.name;
                userNumber.textContent = info.number;
            });

            // Manejar autenticaci√≥n
            socket.on('authenticated', () => {
                loadingIndicator.style.display = 'block';
                qrCode.style.display = 'none';
                errorMessage.style.display = 'none';
            });

            // Manejar conexi√≥n ya existente
            socket.on('alreadyConnected', (info) => {
                loadingIndicator.style.display = 'none';
                qrCode.style.display = 'none';
                connectionInfo.style.display = 'block';
                disconnectBtn.style.display = 'block';
                errorMessage.style.display = 'none';
                
                userName.textContent = info.name;
                userNumber.textContent = info.number;
            });

            // Manejar cierre de sesi√≥n exitoso
            socket.on('loggedOut', () => {
                loadingIndicator.style.display = 'block';
                connectionInfo.style.display = 'none';
                disconnectBtn.style.display = 'none';
                
                // Reiniciar conexi√≥n
                setTimeout(() => {
                    socket.emit('startConnection');
                }, 1000);
            });

            // Evento para bot√≥n de desconexi√≥n
            disconnectBtn.addEventListener('click', () => {
                socket.emit('logout');
                disconnectBtn.disabled = true;
                disconnectBtn.textContent = 'Desconectando...';
            });

            // Prevenir acci√≥n en bot√≥n alternativo (placeholder)
            altLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                alert('Esta funci√≥n no est√° disponible actualmente');
            });
        });
    </script>
</body>
</html>